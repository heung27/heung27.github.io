---
layout: post
title: Cookie & Session
date: 2022-02-25 23:01 +0900
categories: [Server, Web]
tags: [HTTP, Cookie, Session]
---



웹 서버 개발에 기본적인 개념인 Cookie(쿠키)와 Session(세션)에 대해 정리한다. 

들어가기 전에 웹 통신에 사용되는 프로토콜인 HTTP의 특징을 알아보고 쿠키와 세션이 필요한 이유를 먼저 이해하자.

<br>

## HTTP의 특징

#### - 비연결성(Connectionless)

클라이언트에서 서버에 요청을 보내면 서버는 클라이언트에 응답을 하고 연결을 끊어 버린다. 

#### - 무상태(Stateless)

요청에 응답하고 연결을 끊기 때문에 서버는 클라이언트의 상태를 저장하지 않는다. 

<br>

이러한 특징 때문에 서버는 같은 사용자(클라이언트)가 보내는 요청도 매번 새로운 사용자로 인식하게 되는 문제가 있다. 

그런데 우리가 사용하는 웹사이트를 생각해 보자. 로그인을 한 번 하고 나면 그 사이트에서는 다시 로그인할 필요가 없이 여러 페이지의 다양한 기능을 이용할 수 있다. 마치 서버가 사용자의 정보를 유지하고 있는 것처럼 보인다. 

이처럼 HTTP의 비연결성과 무상태를 보완하여 Statefule한 서비스를 제공하기 위해 사용하는 것이 쿠키와 세션이다.

<br>

#### HTTP 통신을 사용하는 이유

HTTP를 사용하여 Stateful한 서비스를 제공하기 위해 쿠키와 세션을 이용한다고 했다. 그렇다면 굳이 Stateless한 HTTP 통신을 사용하는 이유는 뭘까. 애초에 Stateful한 통신 방법을 사용하면 되지 않나?

이 의문의 답은 **서버의 확장성**에 있다. 

사용자가 늘어나 증가한 트래픽을 분산하기 위해 scale out하는 경우를 생각해 보자.

**Stateful 서버**는 메모리에 사용자의 정보를 저장한다. 추가되는 새로운 서버에는 사용자의 정보가 저장되어 있지 않기 때문에 정상적인 응답이 불가능하다. (방법이 없는 것은 아니지만 구현하기 까다롭다고 한다)

**Stateless 서버**는 외부 저장소에 사용자의 정보를 저장한다. 새로운 서버가 추가된다고 하더라도 외부 저장소에서 사용자의 정보를 불러와 사용할 수 있기 때문에 정상적인 응답이 가능하다.

>그러나 Stateless가 장점만 가지고 있는 것은 아니다. 서버로 요청을 보낼 때, 매 요청 시마다 상태 정보를 전달해야 하기 때문에 그만큼 네트워크 리소스를 소모하게 된다. 
>
>Stateful와 Stateless에 대한 자세한 내용은 추후 다른 포스팅에서 정리한다.

<br>

## Cookie (쿠키)

쿠키는 웹 브라우저에 저장되는 Key-Value 쌍의 작은 데이터 파일이다. 사용자의 정보를 저장하기 위한 임시 파일로, 서버로 요청을 보낼 때 함께 보내고 응답을 받을 때 함께 전달받아 사용자의 정보를 이어나간다. 

<br>

### 구성 요소

- 이름(name) : 각각의 쿠키를 구별하는 데 사용되는 이름
- 값(value) : 쿠키의 이름과 관련된 값
- 유효시간(expire) : 쿠키의 유지시간
- 도메인(domain) : 쿠키를 전송할 도메인
- 경로(path) : 쿠키를 전송할 요청 경로

<br>

### 특징

- 이름, 값, 만료일(저장 기간 설정), 경로 정보로 구성되어 있다.
- 클라이언트에 총 300개의 쿠키를 저장할 수 있다.
- 하나의 도메인 당 20개의 쿠키를 가질 수 있다.
- 하나의 쿠키는 4KB(=4096byte)까지 저장 가능하다.

<br>

### 동작 과정

![cookie](/assets/img/cookie.png)

1. 클라이언트가 페이지를 요청한다. (사용자가 웹 사이트 접근)
2. 서버는 쿠키를 생성한다.
3. 생성한 쿠키에 사용자 정보를 담아 클라이언트에게 전달한다. (HTTP 헤더에 포함됨)
4. 전달받은 쿠키는 클라이언트 PC에 저장된다.
5. 이후 다시 서버에 요청을 보낼 때 쿠키를 함께 전달한다. (브라우저에 의해 자동 처리)
6. 서버는 전달받은 쿠키를 이용하여 해당 요청을 처리하고 응답한다.

<br>

### 사용 예시

- ID 저장, 로그인 상태 유지
- 팝업창 일주일간 다시 보지 않기
- 최근 검색한 상품들을 광고에서 추천
- 쇼핑몰 장바구니 기능

<br>

### 한계

- 서버가 가지고 있는 것이 아니라 사용자 측에 저장되기 때문에, 정보를 임의로 고쳐 사용할 수 있어 악용이 가능하다.
- 요청 정보는 가로채기 쉽기 때문에 보안이 취약하다.

<br>

이러한 단점을 보완해 주는 것이 세션이다.

<br>

## Session (세션)

보안이 취약하다는 쿠키의 한계를 극복하기 위해 사용한다. 쿠키를 기반으로 동작하지만, 쿠키와 달리 사용자의 정보를 클라이언트 측이 아닌 서버 측에서 관리한다. 클라이언트는 서버로부터 세션 정보를 찾기 위한 세션 ID만 전달받는다. 세션 정보를 저장하는 장소는 서버의 메모리 일 수도 있지만 다중 서버 환경에서는 외부 저장소를 사용한다. 

<br>

### 특징

- 각 클라이언트에게 고유 ID를 부여한다.
- 서버는 세션 ID로 클라이언트를 구분하고 클라이언트의 요구에 맞는 서비스를 제공한다. 
- 세션 ID는 웹 브라우저당 한 개씩 생성되어 웹 컨테이너에 저장되며 브라우저 종료 시 소멸된다.
- 접속 시간에 제한을 두어 일정 시간 응답이 없다면 정보가 유지되지 않도록 설정이 가능하다.
- 클라이언트는 고유 ID만 가지고 있고 사용자에 대한 정보를 서버에 두기 때문에 비교적 보안이 좋다.

<br>

### 동작 과정

![session](/assets/img/session.png)

1. 클라이언트가 페이지를 요청한다. (사용자가 웹사이트 접근)
2. 서버는 세션 ID를 만들고 해당 사용자의 정보를 세션 ID와 함께 저장한다.
3. 생성한 세션 ID를 쿠키에 담아 클라이언트에게 전달한다. (HTTP 헤더에 포함됨)
4. 전달받은 쿠키는 클라이언트 PC에 저장된다.
5. 이후 다시 서버에 요청할 때 요청과 쿠키를 함께 전달한다. (브라우저에 의해 자동 처리)
6. 서버는 전달받은 쿠키에 있는 세션 ID를 활용하여 사용자 정보를 불러온다.
7. 불러온 사용자 정보를 통해 해당 요청을 처리하고 응답한다.

<br>

### 한계

- 사용자가 많아질수록 서버 메모리를 많이 차지하게 된다. 
- 동접자 수가 많은 경우 서버에 과부하를 주게 되므로 성능 저하의 요인이 된다.

<br>

## Cookie  vs  Sessoin

|                                 | **쿠키 (Cookie)**                                            | **세션 (Session)**                          |
| ------------------------------- | ------------------------------------------------------------ | ------------------------------------------- |
| **저장 위치**                   | 클라이언트(=사용자 PC)                                       | 웹 서버                                     |
| **저장 형식**                   | text                                                         | Object                                      |
| **만료 시점**                   | 쿠키 저장시 설정 <br />(브라우저가 종료되어도 만료시점이 지나지 않으면 자동삭제되지 않음) | 브라우저 종료시 삭제<br /> (기간 지정 가능) |
| **사용하는 자원<br />(리소스)** | 클라이언트 리소스                                            | 웹 서버 리소스                              |
| **용량 제한**                   | 총 300개 하나의 도메인 당 20개 하나의 쿠키 당 4KB(=4096byte) | 서버가 허용하는 한 용량제한 없음            |
| **속도**                        | 상대적으로 빠름                                              | 상대적으로 느림                             |
| **보안**                        | 상대적으로 나쁨                                              | 상대적으로 좋음                             |

<br>

쿠키/세션 방식은 서버에서 추가적인 저장 공간이 필요하고 부하도 높아진다. 또한 해커가 HTTP 요청을 가로챘을 경우, 그 안에 있는 쿠키를 이용해 HTTP 요청을 보낼 수 있다.(세션 하이재킹 공격이라고 한다)

최근에는 이런 문제들을 보완한 토큰 기반의 인증 방식을 사용하는 추세이다. 그중 JWT(Json Web Token)에 대해 다음 포스팅에서 자세히 다뤄본다.

<br>

## Reference

- [https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-2#](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-2#)
- [https://junhyunny.github.io/information/cookie-and-session/](https://junhyunny.github.io/information/cookie-and-session/)
- [https://junshock5.tistory.com/83](https://junshock5.tistory.com/83)
- [https://devuna.tistory.com/23](https://devuna.tistory.com/23)
- [https://hahahoho5915.tistory.com/32](https://hahahoho5915.tistory.com/32)
